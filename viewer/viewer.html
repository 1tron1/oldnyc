<!DOCTYPE html>
<html>
<head>
  <title>Map dot viewer</title>
  <!-- Google Maps API -->
  <script type="text/javascript"
      src="http://maps.google.com/maps/api/js?sensor=false">
  </script>
  <script type="text/javascript" src="lat-lons.js"></script>

  <script type="text/javascript" src="jquery/jquery-1.5.1.min.js"></script>
  <script type="text/javascript" src="jquery/jquery-ui-1.8.14.custom.min.js"></script>

  <link type="text/css" href="jquery/jquery-ui-1.8.14.custom.css" rel="stylesheet" />
  
  <script type="text/javascript">
    var markers = [];
    var marker_dates = [];
    var map;

    function el(id) {
      return document.getElementById(id);
    }

    function makeCallback(photo_id) {
      return function(e) {
        var id = photo_id.toLowerCase().replace('-', '');
        var url = 'http://webbie1.sfpl.org/multimedia/thumbnails/' + id + '_x.jpg';
        el('thumbnail').src = url;
        el('description').innerHTML = 'Loading...';
        getDescription(photo_id);
      };
    }

    function getDescription(photo_id) {
      var req = new XMLHttpRequest();
      var caller = this;
      req.onreadystatechange = function () {
        if (req.readyState == 4) {
          if (req.status == 200 ||  // Normal http
              req.status == 0) {    // Chrome w/ --allow-file-access-from-files
            var info = eval('(' + req.responseText + ')');
            el("description").innerHTML =
              info.title + '<br/>' +
              info.date + '<br/>' +
              info.folder + '<br/><br/>' +
              '<a href="' + info.library_url + '">&rarr; Library</a>';
          }
        }
      };

      req.open("GET", '/info?id=' + photo_id, true);
      req.send(null);
    }

    function initialize_map() {
      var latlng = new google.maps.LatLng(37.77493, -122.419416);
      var opts = {
        zoom: 13,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        streetViewControl: true
      };
      map = new google.maps.Map(el("map"), opts);

      for (var i = 0; i < lat_lons.length; i++) {
        var ll = lat_lons[i];
        marker = new google.maps.Marker({
          position: new google.maps.LatLng(ll[0], ll[1]), 
          map: map,
          flat: true,
          visible: true,
          icon: 'red-dot.png',
          title: ll[4]
        });
        markers.push(marker);
        marker_dates.push([new Date(ll[2]), new Date(ll[3]), marker]);
        google.maps.event.addListener(marker, 'click', makeCallback(ll[4]));
      }
    }

    function updateVisibleMarkers(date1, date2) {
      for (var i = 0; i < marker_dates.length; i++) {
        var md = marker_dates[i];
        var marker = md[2];
        var vis = marker.getVisible();
        if (!vis && md[0] >= date1 && md[1] <= date2) {
          marker.setVisible(true);
        } else if (vis && (md[0] < date1 || md[1] > date2)) {
          marker.setVisible(false);
        }
      }
    }

    function sizeElements() {
      var winW = 630, winH = 460;
      if (document.body && document.body.offsetWidth) {
       winW = document.body.offsetWidth;
       winH = document.body.offsetHeight;
      }
      if (document.compatMode=='CSS1Compat' &&
          document.documentElement &&
          document.documentElement.offsetWidth ) {
       winW = document.documentElement.offsetWidth;
       winH = document.documentElement.offsetHeight;
      }
      if (window.innerWidth && window.innerHeight) {
       winW = window.innerWidth;
       winH = window.innerHeight;
      }

      // TODO(danvk): window.resize
      el("map").style.width = (winW - 230) + "px";
      el("map").style.height = (winH - 100) + "px";
      el("slider").style.width = el("map").style.width;
      el("date_range").style.width = el("map").style.width;
      el("info").style.height = (winH - 100) + "px";
      $('#slider').slider({
        range: true,
        values: [1850, 2000],
        min: 1850,
        max: 2000,
        slide: function(event, ui) {
          el("date_range").innerHTML = ui.values[0] + ' - ' + ui.values[1];
          date1 = ui.values[0];
          date2 = ui.values[1];
          updateVisibleMarkers(new Date(date1 + "/01/01"), new Date(date2 + "/12/31"));
        },
        change: function(event, ui) {
        }
      });
    }
  </script>
</head>
<body onload="initialize_map()" onresize="sizeElements()">
  <!-- TODO(danvk): CSS -->
  <div id="slider" style="position: absolute; top: 10px; left: 10px; width: 200px;"></div>
  <div id="date_range" style="position: absolute; top: 30px; left: 10px; width: 200px; height: 20px; text-align: center;"></div>

  <div id="map" style="position: absolute; top: 50px; left: 10px; width: 200px; height: 600px;"></div>
  <div id="info" style="position: absolute; top: 50px; right: 10px; width:
  200px; height: 100px;">
    <img id="thumbnail" />
    <div id="description"></div>
  </div>

  <script type="text/javascript">
    sizeElements();
  </script>
</body>
</html>
